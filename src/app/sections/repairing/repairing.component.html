<div fxLayout="column" fxLayoutGap="32px">
    <h1 class="cc-display-1">Repairing</h1>
    <div fxLayout="column" fxLayoutGap="24px">
        <mat-card>
            <mat-card-content [formGroup]="filters" gdColumns="1fr 1fr 1fr" gdGap="16px">
                <mat-form-field>
                    <mat-label>IDs</mat-label>
                    <input formControlName="ids" matInput />
                    <mat-hint>id0,id1</mat-hint>
                </mat-form-field>
                <mat-form-field>
                    <mat-label>Namespace</mat-label>
                    <input formControlName="ns" matInput />
                </mat-form-field>
                <cc-date-range formControlName="timespan"></cc-date-range>
                <mat-form-field>
                    <mat-label>Provider ID</mat-label>
                    <input formControlName="provider_id" matInput />
                </mat-form-field>
                <mat-form-field>
                    <mat-label>Status</mat-label>
                    <mat-select formControlName="status">
                        <mat-option [value]="null">any</mat-option>
                        <mat-option
                            *ngFor="let statusName of status | enumKeys"
                            [value]="status[statusName]"
                        >
                            {{ statusName }}
                        </mat-option>
                    </mat-select>
                </mat-form-field>
                <mat-form-field>
                    <mat-label>Error message</mat-label>
                    <input formControlName="error_message" matInput />
                </mat-form-field>
            </mat-card-content>
            <mat-card-footer *ngIf="inProgress$ | async">
                <mat-progress-bar mode="indeterminate"></mat-progress-bar>
            </mat-card-footer>
        </mat-card>

        <ng-container *ngIf="!(inProgress$ | async) || (machines$ | async)">
            <cc-actions>
                <button mat-button (click)="update()">UPDATE</button>
                <button
                    [disabled]="!selection?.selected?.length"
                    color="primary"
                    mat-button
                    (click)="repairByScenario()"
                >
                    REPAIR BY SCENARIO
                </button>
                <button
                    [disabled]="!selection?.selected?.length"
                    color="primary"
                    mat-button
                    (click)="repair()"
                >
                    SIMPLE REPAIR
                </button>
            </cc-actions>

            <cc-empty-search-result *ngIf="!(machines$ | async)?.length"></cc-empty-search-result>
            <mat-card *ngIf="(machines$ | async)?.length" fxLayout="column" fxLayoutGap="18px">
                <table [dataSource]="machines$ | async" mat-table>
                    <cc-select-column
                        [dataSource]="machines$ | async"
                        (changed)="selection = $event"
                    ></cc-select-column>
                    <ng-container [matColumnDef]="cols.def.id">
                        <th *matHeaderCellDef mat-header-cell>ID</th>
                        <td *matCellDef="let i" mat-cell>{{ i.id }}</td>
                    </ng-container>
                    <ng-container [matColumnDef]="cols.def.namespace">
                        <th *matHeaderCellDef mat-header-cell>Namespace</th>
                        <td *matCellDef="let i" mat-cell>{{ i.ns }}</td>
                    </ng-container>
                    <ng-container [matColumnDef]="cols.def.createdAt">
                        <th *matHeaderCellDef mat-header-cell>Created at</th>
                        <td *matCellDef="let i" mat-cell>
                            {{ i.created_at | date: 'dd.MM.yyyy HH:mm:ss' }}
                        </td>
                    </ng-container>
                    <ng-container [matColumnDef]="cols.def.status">
                        <th *matHeaderCellDef mat-header-cell matTooltip="Hover to view details">
                            <span matBadge="ℹ" matBadgeOverlap="false" matBadgeSize="small">
                                Status
                            </span>
                        </th>
                        <td
                            *matCellDef="let i"
                            [matTooltip]="i.error_message"
                            mat-cell
                            matTooltipPosition="left"
                        >
                            {{ i.status | enumKey: status }}
                        </td>
                    </ng-container>
                    <ng-container [matColumnDef]="cols.def.provider">
                        <th *matHeaderCellDef mat-header-cell>Provider</th>
                        <td *matCellDef="let i" mat-cell>
                            {{ i.provider_id }}
                        </td>
                    </ng-container>
                    <ng-container [matColumnDef]="cols.def.history">
                        <th *matHeaderCellDef mat-header-cell matTooltip="Hover to view details">
                            <span matBadge="ℹ" matBadgeOverlap="false" matBadgeSize="small"
                                >History</span
                            >
                        </th>
                        <td
                            *matCellDef="let i"
                            [matTooltip]="i.history?.length ? (i.history | json) : ''"
                            mat-cell
                            matTooltipPosition="left"
                        >
                            {{ i.history?.length || '' }}
                        </td>
                    </ng-container>
                    <tr *matHeaderRowDef="cols.list" mat-header-row></tr>
                    <tr *matRowDef="let row; columns: cols.list" mat-row></tr>
                </table>

                <cc-show-more-button
                    *ngIf="hasMore$ | async"
                    [inProgress]="inProgress$ | async"
                    (fetchMore)="fetchMore()"
                ></cc-show-more-button>
            </mat-card>
        </ng-container>
    </div>
</div>
